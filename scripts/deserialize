#!/usr/bin/env python

import sys
import argparse

from avro.datafile import DataFileReader
from avro.io import DatumReader
import numpy as np

from bioimg import BioImgPlane


def make_parser():
    parser = argparse.ArgumentParser()
    parser.add_argument('img_file', metavar='IMG_FILE')
    return parser


# no schema needed for deserialization
def iterplanes(img_file):
    with open(img_file, 'rb') as f:
        reader = DataFileReader(f, DatumReader())
        for r in reader:
            yield BioImgPlane(r)


def main(argv):
    parser = make_parser()
    args = parser.parse_args(argv)
    for p in iterplanes(args.img_file):
        pixels = p.get_xy()
        print p.name, p.dimension_order, pixels.shape
        print pixels[:2, :2]
        out_fn = '%s-z%04d-c%04d-t%04d.npy' % (p.name, p.z, p.c, p.t)
        np.save(out_fn, pixels)


if __name__ == '__main__':
    main(sys.argv[1:])
